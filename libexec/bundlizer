#!/bin/bash

set -e

# Define constants

  readonly PREFIX=$(cd $(dirname $0)/.. && pwd)
  readonly BUNDLES=$PREFIX/bundles
  readonly COMMANDS=$PREFIX/commands

  readonly bin_name=`basename $0`
  readonly command=$1


# Check requirements

  function initialize {
    if ! type gem &> /dev/null; then
      warn 'RubyGems not found'
    fi

    if ! type bundle &> /dev/null; then
      warn 'Bundler not found'
    fi

    if [ ! -d $BUNDLES ]; then
      mkdir -p $BUNDLES/bin
    fi

    include_commands
  }


# Include the Bundlizer commands

  function include_commands {
    for command_file in `ls $COMMANDS/*`; do
      source $command_file
    done
  }


# Display warning message and exit

  function warn {
    echo $1
    exit 1
  }


  function usage {
    echo "Usage for $bin_name"
    echo
    echo 'Basic commands:'
    echo '  install  user/repository #=> git://github.com/user/repository'
    echo '  update   [repository]'
    echo
    echo '  help'
    echo '  version'
    exit 0
  }


# Start the Bundlizer

  function bundlizer {

    [ -z $command ] && usage || {
      initialize

      case $command in
        'help' | '--help')
          usage
          ;;
        *)
          if [ $(command -v $command) ]; then
            shift 1
            $command $@
          else
            warn "$bin_name: Could not find command \"$command\". See '$bin_name help' for more information on a specific command"
          fi
          ;;
      esac

      exit 0
    }
  }


bundlizer $@
