#!/bin/bash

set -e


# Define constants

    readonly PREFIX=$(cd $(dirname $0)/.. && pwd)
    readonly BUNDLES=$PREFIX/bundles
    readonly COMMANDS=$PREFIX/libexec

    readonly bin_name=`basename $0`
    readonly command=$1


# Check requirements

    function initialize {
      if ! type gem &> /dev/null; then
        echo 'RubyGems not found'
        exit 1
      fi

      if ! type bundle &> /dev/null; then
        echo 'Bundler not found'
        exit 1
      fi

      if [ ! -d $PREFIX/apps ]; then
        mkdir -p $PREFIX/apps
      fi

    }


# Display the Bundlizer help

    function usage {
      echo "Usage for $bin_name"
      echo
      echo 'Basic commands:'
      echo '  install  user/repository #=> git://github.com/user/repository'
      echo '  update   [repository]'
      echo
      echo '  help'
      echo '  version'
      exit 0
    }


# Start the Bundlizer

    function bundlizer {

      [ -z $command ] && usage || {
        initialize

        case $command in
        'help' | '--help')
          usage
          ;;
        *)
          if [ -f "$COMMANDS/bundlizer-$command" ]; then
            shift 1
            exec "$COMMANDS/bundlizer-$command" $@
          else
            echo "$bin_name: Could not find command \"$command\". See '$bin_name help' for more information on a specific command"
            exit 1
          fi
          ;;
        esac

        exit 0
      }
    }


bundlizer $@
